insert into QCSAMPLE.SAMPLE
(
SAMPLE_IID,
SAMPLE_ID,
MASTER_LOT_IID,
ORIGINAL_SAMPLE_IND,
SHIPPING_LABEL_ID,
SAMPLE_TYPE_CDE,
SAMPLE_CATEGORY_CDE,
SAMPLE_STATUS_CDE,
SAMPLE_COLL_MEDIUM_CDE,
SAMPLE_CREATION_DTE,
LAB_RECEIVED_DTE,
SAMPLE_EXTRACTED_DTE,
SAMPLE_POOLED_DTE,
EXPIRATION_DTE,
STORAGE_ENVIRON_NME,
STORAGE_UNIT_NME,
SHELF_NUM,
BOX_NUM,
SLOT_LOCATION_NME,
SAMPLE_UNIT_VOL,
SAMPLE_UNIT_UOM,
SAMPLES_STORED_QTY,
SAMPLE_STORED_QTY_UOM,
CONCENTRATION_QTY,
CONCENTRATION_QTY_UOM,
SAMPLE_LABELED_BY,
COMMENT_TXT,
CREATE_TS,
CREATE_BY_ID,
UPDATE_TS,
UPDATE_BY_ID
)
select 
QCSAMPLE.SEQ_SAMPLE.NEXTVAL,
ml.MASTER_LOT_ID || '.' || lpad(l.ll,6,'0') || 'N' as SAMPLE_ID,
ml.MASTER_LOT_IID,
'N' as ORIGINAL_SAMPLE_IND,
e.SAMPLE_ID as SHIPPING_LABEL_ID,
e.ML_SAMPLE_TYPE as SAMPLE_TYPE_CDE,
'MASTER' as SAMPLE_CATEGORY_CDE,
case when ROW_NUMBER() OVER (PARTITION BY ml.MASTER_LOT_IID ORDER BY ml.MASTER_LOT_IID) > e.VIALS_LEFT then 'DEPLETED' else 'ACTIVE' end as SAMPLE_STATUS_CDE,
e.ML_MEDIUM as SAMPLE_COLL_MEDIUM_CDE,
null as SAMPLE_CREATION_DTE,
null as LAB_RECEIVED_DTE,
null as SAMPLE_EXTRACTED_DTE,
null as SAMPLE_POOLED_DTE,
null as EXPIRATION_DTE,
e.Environment_Name as STORAGE_ENVIRON_NME,
e.STORAGE_UNIT as STORAGE_UNIT_NME,
null as SHELF_NUM,
null as BOX_NUM,
null as SLOT_LOCATION_NME,
e.ML_Unit_Volumne as SAMPLE_UNIT_VOL,
e.ML_Unit_Of_Measure as SAMPLE_UNIT_UOM,
case when ROW_NUMBER() OVER (PARTITION BY ml.MASTER_LOT_IID ORDER BY ml.MASTER_LOT_IID) > e.VIALS_LEFT then null else 1 end as SAMPLES_STORED_QTY,
case when ROW_NUMBER() OVER (PARTITION BY ml.MASTER_LOT_IID ORDER BY ml.MASTER_LOT_IID) > e.VIALS_LEFT then null else 'unit' end as SAMPLE_STORED_QTY_UOM,
replace(upper(e.NO_OF_CELLS_VIAL),'X10E6','') as CONCENTRATION_QTY,
'x10^6 cells/mL' as CONCENTRATION_QTY_UOM,
null as SAMPLE_LABELED_BY,
null as COMMENT_TXT,
SYSTIMESTAMP as CREATE_TS,
'bods_user' as CREATE_BY_ID,
SYSTIMESTAMP as UPDATE_TS,
'bods_user' as UPDATE_BY_ID
from ETL_STAGE.QCSAMPLE_INV_EXCEL_BLCL e
inner join QCSAMPLE.SAMPLE_SOURCE ss on e.SAMPLE_ID = ss.SAMPLE_SOURCE_ID
inner join QCSAMPLE.MASTER_LOT ml on ml.SAMPLE_SOURCE_IID = ss.SAMPLE_SOURCE_IID
inner join (select level ll from dual d
connect by level <=10000) l on l.ll <= ml.ORIGINAL_QTY
where e.QC_MASTER_LOT_ID is not null;

commit;


