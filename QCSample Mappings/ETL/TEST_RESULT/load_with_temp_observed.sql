Begin
Execute Immediate ('truncate table QCSAMPLE_OTR_TEMP');
Execute Immediate ('drop table QCSAMPLE_OTR_TEMP');
Exception when others then
If sqlcode = -942 then
     Null;
   Else
    Raise;
   End If;
  End;
/

create global temporary table QCSAMPLE_OTR_TEMP 
on commit preserve rows
as select
	SEQ_TEST_RESULT.NEXTVAL as TEST_RESULT_IID,
	otr.hla_hist_id,    
	otr.org_guid as REPORTING_BP_GUID,
	otr.reporting_method_cde as REPORTING_METHOD_CDE,
	otr.sequence_num as SEQ_NUM,
	otr.typing_dte as TEST_DTE,
	otr.received_dte as RESULT_RECEIVED_DTE,
  otr.PHENOTYPE_SEQ_NUM,
  ss.shipping_label_id
from QCSAMPLE.QCSAMPLE_TR_SYBASE_OTR otr
inner join QCSAMPLE.SAMPLE_SHIPMENT ss on cast(replace(ss.shipping_label_id,'-','') as number) = otr.nmdp_did
where ss.SHIPPING_LABEL_ID not like '%.%'; -- ignore fake records

insert into QCSAMPLE.TEST_RESULT
(
	TEST_RESULT_IID,
	SUBJECT_REF_ID,
	REPORTING_BP_GUID,
	REPORTING_METHOD_CDE,
	SEQ_NUM,
	TEST_DTE,
	RESULT_RECEIVED_DTE,
	TEST_REASON_CDE,
	TEST_METHOD_CDE,
	TEST_METHOD_GROUP_CDE,
	COLLECTION_METHOD_TXT,
	DOCID_GUID,
	ORDER_GUID,
	CREATE_TS,
	CREATE_BY_ID,
	UPDATE_TS,
	UPDATE_BY_ID
)
select 
	TEST_RESULT_IID,
	SYS_GUID() as SUBJECT_REF_ID,
	REPORTING_BP_GUID,
	REPORTING_METHOD_CDE,
	SEQ_NUM,
	TEST_DTE,
	RESULT_RECEIVED_DTE,
	'LAB' as TEST_REASON_CDE,
	'DNA' as TEST_METHOD_CDE,
	'DNA' as TEST_METHOD_GROUP_CDE,
	NULL as COLLECTION_METHOD_TXT,
	NULL as DOCID_GUID,
	NULL as ORDER_GUID,
	SYSTIMESTAMP as CREATE_TS,
	'BODS_LOAD' as CREATE_BY_ID,
	SYSTIMESTAMP as UPDATE_TS,
	'BODS_LOAD' as UPDATE_BY_ID
from QCSAMPLE_OTR_TEMP;

insert into QCSAMPLE.TYPING_RESULT
(
	TEST_RESULT_IID,
	SAMPLE_REF_ID,
	GENE_FAMILY_CDE,
	PHENOTYPE_SEQ_NUM,
	COMMENT_TXT,
	CREATE_TS,
	CREATE_BY_ID,
	UPDATE_TS,
	UPDATE_BY_ID
)
select
  TEST_RESULT_IID,
  shipping_label_id as SAMPLE_REF_ID,
  'HLA' as GENE_FSAMILY_CODE,
  PHENOTYPE_SEQ_NUM,
  null as COMMENT_TXT,
	SYSTIMESTAMP as CREATE_TS,
	'BODS_LOAD' as CREATE_BY_ID,
	SYSTIMESTAMP as UPDATE_TS,
	'BODS_LOAD' as UPDATE_BY_ID
from QCSAMPLE_OTR_TEMP;


insert into QCSAMPLE.HAPLOID
(
HAPLOID_IID,
TEST_RESULT_IID,
GENE_LOCUS_LONG_NME,
TYPE_1_NME,
TYPE_2_NME,
OBJECT_TYPE_1_CDE,
OBJECT_TYPE_2_CDE,
TRANSLATED_IND,
TRANSLATED_FROM_CAT_CDE,
GENOME_DATABASE_NME,
DATABASE_VERSION_TXT,
TEST_INTERPRETATION_DTE,
CREATE_TS,
CREATE_BY_ID,
UPDATE_TS,
UPDATE_BY_ID
)
select 
	QCSAMPLE.SEQ_HAPLOID.NEXTVAL,
	tr.TEST_RESULT_IID,
	h.name as GENE_LOCUS_LONG_NME,
	h.a1_type as TYPE_1_NME,
	h.a2_type as TYPE_2_NME,
	null as OBJECT_TYPE_1_CDE, -- ws call
	null as OBJECT_TYPE_2_CDE, -- ws call
	'N' as TRANSLATED_IND,
	null as TRANSLATED_FROM_CAT_CDE,
	'IMGT-HLA' as GENOME_DATABASE_NME,
	null as DATABASE_VERSION_TXT,
	tr.TEST_DTE as TEST_INTERPRETATION_DTE,
	SYSTIMESTAMP as CREATE_TS,
	'BODS_LOAD' as CREATE_BY_ID,
	SYSTIMESTAMP as UPDATE_TS,
	'BODS_LOAD' as UPDATE_BY_ID
from QCSAMPLE.QCSAMPLE_TR_SYBASE_OTR_HAP h
inner join QCSAMPLE_OTR_TEMP tr on tr.hla_hist_id = h.hla_hist_id;
commit;



